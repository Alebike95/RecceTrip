<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rally TripMaster v3</title>
    <style>
        /* --- STILE GRAFICO (CSS) --- */
        :root {
            --bg-color: #000000;
            --text-main: #00FF00;
            --text-dim: #666666;
            --highlight: #FFFFFF;
            --alert: #FF0000;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            height: 100dvh; /* dvh per adattarsi ai browser mobile */
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation; /* Migliora risposta touch */
        }

        /* TOP BAR */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            height: 25%;
            box-sizing: border-box;
            background-color: #050505;
        }

        .small-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 10;
        }

        /* TRIP B (Alto SX) */
        #tripB-container {
            align-items: flex-start;
            cursor: pointer;
            position: relative;
            min-width: 120px; /* Area tocco più grande */
        }

        .label {
            font-size: 2.5vh;
            color: var(--text-dim);
            font-weight: bold;
            letter-spacing: 2px;
        }

        .value-small {
            font-size: 6vh;
            font-weight: bold;
            color: var(--text-main);
            font-variant-numeric: tabular-nums; /* Numeri a larghezza fissa */
        }

        /* AREA CENTRALE (Trip A) */
        .main-trip-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-top: 2px solid #222;
            border-bottom: 2px solid #222;
            position: relative;
            background-color: #000;
        }

        .main-trip-value {
            font-size: 25vh;
            line-height: 0.9;
            font-weight: bold;
            color: var(--highlight);
            font-variant-numeric: tabular-nums;
        }

        .main-trip-unit {
            font-size: 3vh;
            color: var(--text-dim);
            margin-top: 1vh;
            letter-spacing: 5px;
        }

        /* PULSANTE INFO (Basso DX) */
        .info-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #111;
            border: 1px solid #333;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #888;
            font-weight: bold;
            cursor: pointer;
            z-index: 50;
            font-size: 1.5rem;
        }

        /* PANNELLO DIAGNOSTICA */
        .debug-panel {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.98);
            z-index: 100;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 30px;
            overflow-y: auto;
        }
        
        .debug-row {
            font-size: 1rem;
            margin: 8px 0;
            border-bottom: 1px solid #333;
            width: 100%;
            padding-bottom: 5px;
            font-family: monospace;
            color: #ccc;
        }

        .btn-debug {
            margin-top: 15px;
            padding: 15px;
            width: 100%;
            background: #222;
            color: #fff;
            border: 1px solid #444;
            font-size: 1.2rem;
            text-align: center;
        }

        /* BARRA DI PROGRESSO RESET */
        .reset-progress {
            position: absolute;
            bottom: -5px;
            left: 0;
            height: 4px;
            background-color: var(--alert);
            width: 0%;
        }

        /* Feedback visivi */
        .flash { animation: flash-anim 0.2s; }
        .flash-red { animation: flash-red-anim 0.3s; }

        @keyframes flash-anim {
            0% { background-color: #333; }
            100% { background-color: #000; }
        }
        @keyframes flash-red-anim {
            0% { background-color: #500; }
            100% { background-color: #000; }
        }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="small-box" id="tripB-container">
            <span class="label">TRIP B</span>
            <span class="value-small" id="tripB-val">0.00</span>
            <div class="reset-progress" id="reset-bar"></div>
        </div>

        <div class="small-box" style="align-items: flex-end;">
            <span class="label">KM/H</span>
            <span class="value-small" id="speed-val">0</span>
        </div>
    </div>

    <div class="main-trip-container" id="click-area" onclick="handleTapResetA()">
        <span class="main-trip-value" id="tripA-val">0</span>
        <span class="main-trip-unit">METRI</span>
    </div>

    <div class="info-btn" onclick="toggleDebug()">i</div>

    <div class="debug-panel" id="debug-panel">
        <h2 style="color:white; margin-bottom:10px;">DIAGNOSTICA GPS v3.0</h2>
        
        <div class="debug-row">Sorgente: <span id="dbg-hz" style="color:yellow">Calc...</span> Hz</div>
        <div class="debug-row">Precisione: <span id="dbg-acc">--</span> m</div>
        <div class="debug-row">Speed (GPS): <span id="dbg-spd">--</span> m/s</div>
        <div class="debug-row">Delta Dist: <span id="dbg-dist" style="color:cyan">0.00</span> m</div>
        <div class="debug-row">Stato: <span id="dbg-status">Attesa...</span></div>
        <div class="debug-row" style="font-size:0.8rem; color:#666">
            Ultimo Fix: <span id="dbg-time">--</span>
        </div>

        <div class="btn-debug" onclick="goFullscreen()">FULLSCREEN</div>
        <div class="btn-debug" onclick="location.reload()">RICARICA PAGINA</div>
        <div class="btn-debug" style="background:#400" onclick="toggleDebug()">CHIUDI</div>
    </div>

    <script>
        // --- STATO DEL SISTEMA ---
        let tripA = 0.0; // Float per precisione, mostrato intero
        let tripB = 0.0;
        let lastLat = null;
        let lastLon = null;
        
        // Debug vars
        let lastFixTime = 0;
        let updateTimestamps = [];

        // Elementi DOM
        const elTripA = document.getElementById('tripA-val');
        const elTripB = document.getElementById('tripB-val');
        const elSpeed = document.getElementById('speed-val');
        const elResetBar = document.getElementById('reset-bar');
        
        // --- FUNZIONI MATEMATICHE ---
        
        // Calcolo distanza (Haversine Formula) - Restituisce Metri
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Raggio Terra
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // --- GESTIONE GPS ---
        function handlePosition(pos) {
            const now = Date.now();
            const crd = pos.coords;

            // 1. Calcolo Hz (Frequenza)
            updateTimestamps.push(now);
            // Tieni solo gli ultimi 2 secondi per la media
            updateTimestamps = updateTimestamps.filter(t => t > now - 2000);
            const hz = (updateTimestamps.length / 2).toFixed(1);
            
            // 2. Aggiorna Debug
            document.getElementById('dbg-hz').innerText = hz;
            document.getElementById('dbg-hz').style.color = (hz > 5) ? '#00FF00' : '#FFFF00';
            document.getElementById('dbg-acc').innerText = crd.accuracy ? crd.accuracy.toFixed(1) : '--';
            document.getElementById('dbg-spd').innerText = crd.speed ? crd.speed.toFixed(2) : '0.00';
            document.getElementById('dbg-time').innerText = new Date().toLocaleTimeString();
            document.getElementById('dbg-status').innerText = "Running";

            // 3. Visualizzazione Velocità (km/h)
            // Se speed è null (alcuni telefoni), calcolalo non possiamo, mettiamo 0
            let speedKmh = (crd.speed || 0) * 3.6;
            elSpeed.innerText = speedKmh.toFixed(0);

            // 4. CALCOLO DISTANZA (CORE LOGIC)
            if (lastLat !== null && lastLon !== null) {
                // Calcola distanza grezza
                let dist = calculateDistance(lastLat, lastLon, crd.latitude, crd.longitude);
                
                // Debug della distanza grezza
                document.getElementById('dbg-dist').innerText = dist.toFixed(3);

                // --- NUOVA LOGICA DI FILTRO v3.0 ---
                // Problema precedente: a 10Hz dist è piccola (es. 0.3m) e veniva scartata.
                // Nuova regola: 
                // Accettiamo il movimento se la velocità GPS è > 1 km/h (ci stiamo muovendo sicuro)
                // OPPURE se la distanza è > 5 metri (salto di posizione / fix iniziale)
                // Se siamo fermi (speed ~ 0), ignoriamo i micro spostamenti (drift)
                
                let isValidMove = false;

                // Caso A: Il GPS ci dice che abbiamo velocità (più affidabile del delta posizione)
                // 0.28 m/s = 1 km/h. Usiamo 0.8 km/h come soglia minima di movimento.
                if (crd.speed && crd.speed > 0.22) {
                    isValidMove = true;
                }
                // Caso B: Non c'è velocità o è bassa, ma ci siamo spostati tanto (es. tunnel)
                else if (dist > 10.0) { 
                     // Salto troppo grosso in 0.1s? No, accettiamo per recupero fix
                     isValidMove = true;
                }
                // Caso C: Movimento lento (es. manovra). 
                // Se la precisione è ottima (<5m) e dist > 0.1m, accumula
                else if (crd.accuracy < 10 && dist > 0.05) {
                    isValidMove = true;
                }

                if (isValidMove) {
                    tripA += dist;
                    tripB += dist;
                    updateUI();
                } else {
                    document.getElementById('dbg-dist').innerText += " (Ignored)";
                }
            }

            // Salva posizione precedente
            lastLat = crd.latitude;
            lastLon = crd.longitude;
        }

        function handleError(err) {
            document.getElementById('dbg-status').innerText = "ERR: " + err.code + " - " + err.message;
            document.getElementById('dbg-status').style.color = "red";
        }

        function updateUI() {
            elTripA.innerText = Math.floor(tripA);
            elTripB.innerText = (tripB / 1000).toFixed(2);
        }

        // --- INIZIO MONITORAGGIO ---
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0 // Importante: non usare cache
        };
        
        navigator.geolocation.watchPosition(handlePosition, handleError, geoOptions);


        // --- GESTIONE INPUT (Touch & Bluetooth) ---

        // RESET TRIP A
        function handleTapResetA() {
            tripA = 0;
            updateUI();
            flashElement(document.querySelector('.main-trip-container'), 'flash');
        }

        // RESET TOTALE (Trip B) - Logica Pressione 3 secondi
        let pressTimer;
        const btnB = document.getElementById('tripB-container');

        btnB.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            elResetBar.style.width = "100%";
            elResetBar.style.transition = "width 3s linear";
            
            pressTimer = setTimeout(() => {
                // Azione dopo 3 secondi
                tripA = 0;
                tripB = 0;
                updateUI();
                flashElement(document.body, 'flash-red');
                elResetBar.style.width = "0%";
                elResetBar.style.transition = "none";
            }, 3000);
        });

        btnB.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
            elResetBar.style.transition = "width 0.2s ease-out";
            elResetBar.style.width = "0%";
        });

        // GESTIONE PULSANTE BLUETOOTH
        let keyClicks = 0;
        let keyTimer;

        window.addEventListener('keydown', (e) => {
            // Intercetta tasti comuni dei telecomandi
            if (["Enter", " ", "VolumeUp", "VolumeDown", "AudioVolumeUp"].includes(e.key)) {
                
                keyClicks++;
                clearTimeout(keyTimer);

                // Aspetta 400ms per vedere se arrivano altri click
                keyTimer = setTimeout(() => {
                    if (keyClicks >= 3) {
                        // 3 CLICK = RESET TOTALE
                        tripA = 0; tripB = 0;
                        flashElement(document.body, 'flash-red');
                    } else {
                        // 1 o 2 CLICK = RESET TRIP A
                        tripA = 0;
                        flashElement(document.querySelector('.main-trip-container'), 'flash');
                    }
                    updateUI();
                    keyClicks = 0;
                }, 400);
            }
        });

        function flashElement(el, cls) {
            el.classList.remove(cls);
            void el.offsetWidth; // Trigger reflow
            el.classList.add(cls);
        }

        function toggleDebug() {
            const p = document.getElementById('debug-panel');
            p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
        }

        function goFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Errore fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Wake Lock
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) await navigator.wakeLock.request('screen');
            } catch (e) { console.log(e); }
        }
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') requestWakeLock();
        });
        requestWakeLock();

    </script>
</body>
</html>
