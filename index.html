<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rally TripMaster</title>
    <style>
        /* STILE GRAFICO (CSS) */
        body {
            background-color: #000000; /* Sfondo Nero */
            color: #00FF00; /* Testo Verde brillante (stile retro) */
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Evita scorrimento */
        }

        /* Barra superiore */
        .top-bar {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            height: 20%;
            align-items: flex-start;
        }

        .small-box {
            font-size: 3rem; /* Dimensione piccolo trip e velocità */
            font-weight: bold;
        }

        .label {
            font-size: 1rem;
            color: #888;
            display: block;
        }

        /* Area Centrale */
        .main-trip-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-top: 2px solid #333;
            cursor: pointer; /* Indica che è cliccabile */
        }

        .main-trip-value {
            font-size: 8rem; /* Molto grande */
            font-weight: bold;
            color: #ffffff; /* Bianco per contrasto massimo */
        }

        .main-trip-unit {
            font-size: 2rem;
            color: #888;
        }

        /* Feedback visivo al reset */
        .flash {
            background-color: #333333;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="small-box" id="tripB-display">
            <span class="label">TRIP B (KM)</span>
            <span id="tripB-val">0.00</span>
        </div>

        <div class="small-box" id="speed-display" style="text-align: right;">
            <span class="label">SPEED (KM/H)</span>
            <span id="speed-val">0</span>
        </div>
    </div>

    <div class="main-trip-container" id="click-area" onclick="resetTripA()">
        <span class="main-trip-value" id="tripA-val">0</span>
        <span class="main-trip-unit">METRI</span>
    </div>

    <script>
        // VARIABILI
        let tripA_meters = 0;
        let tripB_meters = 0;
        let prevLat = null;
        let prevLon = null;
        
        // Elementi HTML
        const elTripA = document.getElementById('tripA-val');
        const elTripB = document.getElementById('tripB-val');
        const elSpeed = document.getElementById('speed-val');
        const elContainer = document.getElementById('click-area');

        // FUNZIONE: Calcolo distanza tra due coordinate (Haversine Formula semplificata per brevi distanze)
        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Raggio terra in metri
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            const d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        // FUNZIONE: Gestione GPS
        function success(pos) {
            const crd = pos.coords;
            
            // 1. Gestione Velocità
            if (crd.speed !== null) {
                // La velocità arriva in m/s, convertiamo in km/h
                let kmh = (crd.speed * 3.6).toFixed(0);
                elSpeed.innerText = kmh;
            }

            // 2. Gestione Distanza
            if (prevLat != null && prevLon != null) {
                // Calcola distanza dal punto precedente
                // Filtro: se la precisione è bassa o il movimento è infinitesimale, ignoralo
                if (crd.accuracy < 20) { // Accetta solo segnali con precisione sotto i 20m
                    let dist = getDistanceFromLatLonInMeters(prevLat, prevLon, crd.latitude, crd.longitude);
                    
                    // Aggiungi solo se ci siamo mossi davvero (filtro anti-jitter da fermo)
                    if (dist > 0.5) { 
                        tripA_meters += dist;
                        tripB_meters += dist;
                    }
                }
            }

            // Aggiorna coordinate precedenti
            prevLat = crd.latitude;
            prevLon = crd.longitude;

            updateDisplay();
        }

        function error(err) {
            console.warn('ERRORE GPS(' + err.code + '): ' + err.message);
        }

        // Aggiorna lo schermo
        function updateDisplay() {
            // Trip A: Metri interi
            elTripA.innerText = Math.floor(tripA_meters);
            
            // Trip B: Km con 2 decimali
            elTripB.innerText = (tripB_meters / 1000).toFixed(2);
        }

        // Avvia il GPS ad alta precisione
        navigator.geolocation.watchPosition(success, error, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });

        // FUNZIONE: Azzera Trip A
        function resetTripA() {
            tripA_meters = 0;
            updateDisplay();
            
            // Effetto visivo "flash"
            elContainer.classList.add('flash');
            setTimeout(() => {
                elContainer.classList.remove('flash');
            }, 100);
        }

        // GESTIONE PULSANTE BLUETOOTH ESTERNO
        // I pulsanti bluetooth solitamente inviano segnali "Volume" o "Invio"
        window.addEventListener('keydown', function(event) {
            const key = event.key;
            // Codici comuni per telecomandi bluetooth: Enter, VolumeUp, VolumeDown, Space
            if (key === "Enter" || key === "VolumeUp" || key === "VolumeDown" || key === " " || key === "AudioVolumeUp") {
                resetTripA();
                // Impedisce che il volume del telefono cambi davvero (se possibile)
                // event.preventDefault(); 
            }
        });

        // Previeni lo spegnimento schermo (funziona su alcuni browser moderni)
        try {
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen');
            }
        } catch (err) {
            console.log("Wake Lock non supportato");
        }

    </script>
</body>
</html>
