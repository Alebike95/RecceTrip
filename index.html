<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Tripmaster Pro</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            font-family: monospace, sans-serif;
            touch-action: none; /* Previene zoom/pan indesiderati */
            user-select: none; /* Previene selezione testo */
        }
        #container {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            box-sizing: border-box;
        }
        #top-row {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 2% 3%; /* Percentuale per responsive */
            box-sizing: border-box;
            z-index: 10;
        }
        #trip2 {
            font-size: 5vw; /* Responsive: 5% della larghezza viewport */
            cursor: pointer;
        }
        #speed {
            font-size: 5vw;
        }
        #main-trip {
            flex-grow: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            font-size: 20vw; /* Grande e responsive */
            padding-right: 3%; /* Rientro percentuale */
            text-align: right;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            cursor: pointer;
            z-index: 5;
        }
        #buttons {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 2% 0;
            box-sizing: border-box;
            z-index: 10;
        }
        button {
            padding: 1% 2%;
            margin: 0.5%;
            font-size: 3vw; /* Responsive */
            background-color: #333;
            color: #fff;
            border: 1px solid #fff;
            border-radius: 10px;
            min-width: 15%; /* Per non essere troppo piccoli */
        }
        /* Media queries per adattamento */
        @media (max-width: 600px) {
            #trip2, #speed {
                font-size: 6vw;
                padding: 1% 2%;
            }
            #main-trip {
                font-size: 25vw;
                padding-right: 2%;
            }
            button {
                font-size: 4vw;
                padding: 1.5% 3%;
            }
        }
        @media (min-width: 1200px) {
            #trip2, #speed {
                font-size: 3vw;
            }
            #main-trip {
                font-size: 15vw;
            }
            button {
                font-size: 2vw;
            }
        }
        /* Forza landscape su mobile */
        @media (orientation: portrait) {
            body {
                transform: rotate(90deg);
                transform-origin: center;
                width: 100vh;
                height: 100vw;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="top-row">
            <div id="trip2">0</div>
            <div id="speed">0</div>
        </div>
        <div id="main-trip">0</div>
        <div id="buttons">
            <button onclick="connectGPS()">GPS Ext</button>
            <button onclick="connectInternalGPS()">GPS Int</button>
            <button onclick="connectButton()">Btn Ext</button>
        </div>
    </div>

    <script>
        let tripDistance = 0; // Trip principale in metri
        let trip2Distance = 0; // Trip secondario in metri
        let prevLat = null;
        let prevLon = null;
        let speed = 0; // Velocità in km/h
        let reader = null;
        let buttonCharacteristic = null;
        let watchId = null;
        let pressTimer = null;
        let buttonPressStart = null; // Per long press su pulsante esterno

        // Forza orientamento landscape
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('landscape').catch(err => console.log('Orientamento non supportato:', err));
        }

        // Calcola distanza in metri (Haversine migliorata per precisione)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6378137; // Raggio equatoriale Terra per più precisione
            const dLat = degToRad(lat2 - lat1);
            const dLon = degToRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(degToRad(lat1)) * Math.cos(degToRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function degToRad(deg) {
            return deg * (Math.PI / 180);
        }

        // Parsing NMEA avanzato per Garmin GLO (GPGGA per pos, GPRMC per speed)
        function parseNMEA(nmea) {
            if (nmea.startsWith('$GPGGA')) {
                const parts = nmea.split(',');
                if (parts.length > 5 && parts[6] > 0) { // Check fix quality >0
                    let lat = parseFloat(parts[2]) / 100;
                    let lon = parseFloat(parts[4]) / 100;
                    lat = Math.floor(lat) + (lat % 1) * 60 / 100; // Corretta conversione DDMM.mmmm a decimal
                    lon = Math.floor(lon) + (lon % 1) * 60 / 100;
                    if (parts[3] === 'S') lat = -lat;
                    if (parts[5] === 'W') lon = -lon;

                    if (prevLat !== null && prevLon !== null) {
                        const distance = calculateDistance(prevLat, prevLon, lat, lon);
                        if (!isNaN(distance) && distance < 100) { // Filtro per salti impossibili
                            tripDistance += distance;
                            trip2Distance += distance;
                            updateDisplay();
                        }
                    }
                    prevLat = lat;
                    prevLon = lon;
                }
            } else if (nmea.startsWith('$GPRMC')) {
                const parts = nmea.split(',');
                if (parts.length > 7) {
                    const knots = parseFloat(parts[7]);
                    if (!isNaN(knots)) {
                        speed = knots * 1.852; // knots to km/h
                        updateDisplay();
                    }
                }
            }
        }

        // Aggiorna display
        function updateDisplay() {
            document.getElementById('main-trip').textContent = Math.round(tripDistance);
            document.getElementById('trip2').textContent = Math.round(trip2Distance);
            document.getElementById('speed').textContent = Math.round(speed);
        }

        // Reset trip principale (short press)
        function resetMainTrip() {
            tripDistance = 0;
            updateDisplay();
        }

        // Reset trip2 (long press 3s)
        function resetTrip2() {
            trip2Distance = 0;
            updateDisplay();
        }

        // Gestione touch su schermo per reset
        const mainTripElement = document.getElementById('main-trip');
        mainTripElement.addEventListener('touchstart', resetMainTrip);
        const trip2Element = document.getElementById('trip2');
        trip2Element.addEventListener('touchstart', () => {
            pressTimer = setTimeout(resetTrip2, 3000);
        });
        trip2Element.addEventListener('touchend', () => clearTimeout(pressTimer));
        trip2Element.addEventListener('touchcancel', () => clearTimeout(pressTimer));

        // Connessione GPS Esterno (Garmin GLO via Web Serial)
        async function connectGPS() {
            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 4800, bufferSize: 1024 }); // Ottimizzato per GLO
                const textDecoder = new TextDecoderStream();
                port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();
                (async () => {
                    let buffer = '';
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += value;
                        let lines = buffer.split('\r\n');
                        buffer = lines.pop();
                        lines.forEach(line => line.startsWith('$') && parseNMEA(line));
                    }
                })();
            } catch (err) {
                console.error('Errore GPS Ext:', err);
            }
        }

        // GPS Interno (fallback)
        function connectInternalGPS() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const spd = position.coords.speed || 0;
                    speed = spd * 3.6; // m/s to km/h
                    if (prevLat !== null && prevLon !== null) {
                        const distance = calculateDistance(prevLat, prevLon, lat, lon);
                        if (!isNaN(distance) && distance < 100) {
                            tripDistance += distance;
                            trip2Distance += distance;
                            updateDisplay();
                        }
                    }
                    prevLat = lat;
                    prevLon = lon;
                }, err => console.error('Errore GPS Int:', err), { enableHighAccuracy: true, maximumAge: 0 });
            }
        }

        // Connessione Pulsante Esterno BLE (gestione short/long press)
        async function connectButton() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, // Adatta a filters specifici se noto UUID
                    optionalServices: ['generic_hid'] // Assumi HID per button
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('generic_hid');
                buttonCharacteristic = await service.getCharacteristic('report');
                await buttonCharacteristic.startNotifications();
                buttonCharacteristic.addEventListener('characteristicvaluechanged', event => {
                    const value = event.target.value.getUint8(0);
                    if (value === 1) { // Press start
                        buttonPressStart = Date.now();
                    } else if (value === 0 && buttonPressStart) { // Release
                        const duration = Date.now() - buttonPressStart;
                        if (duration >= 3000) {
                            resetTrip2();
                        } else {
                            resetMainTrip();
                        }
                        buttonPressStart = null;
                    }
                });
            } catch (err) {
                console.error('Errore Btn Ext:', err);
            }
        }
    </script>
</body>
</html>
