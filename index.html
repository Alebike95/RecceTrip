<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tripmaster</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none; /* Previene zoom/scroll indesiderato */
        }
        #container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        #top-row {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
        }
        #trip2 {
            font-size: 24px;
            cursor: pointer;
        }
        #speed {
            font-size: 24px;
        }
        #main-trip {
            font-size: 96px;
            text-align: right;
            padding-right: 10px; /* Rientro di 1 (inteso come piccolo indent) */
            flex-grow: 1;
            display: flex;
            align-items: center;
            width: 100%;
        }
        #buttons {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }
        button {
            padding: 5px 10px;
            margin: 0 5px;
            font-size: 12px;
            background-color: #333;
            color: #fff;
            border: 1px solid #fff;
            border-radius: 5px;
        }
        /* Forza landscape */
        @media (orientation: portrait) {
            body {
                transform: rotate(90deg);
                width: 100vh;
                height: 100vw;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="top-row">
            <div id="trip2">0</div>
            <div id="speed">0 km/h</div>
        </div>
        <div id="main-trip">0</div>
        <div id="buttons">
            <button onclick="connectGPS()">GPS</button>
            <button onclick="connectInternalGPS()">Int GPS</button>
            <button onclick="connectButton()">Btn</button>
            <button onclick="resetTrip()">Rst</button>
        </div>
    </div>

    <script>
        let tripDistance = 0; // Trip principale
        let trip2Distance = 0; // Trip secondario
        let prevLat = null;
        let prevLon = null;
        let speed = 0; // Velocità in km/h
        let reader = null;
        let buttonCharacteristic = null;
        let watchId = null;
        let pressTimer = null;

        // Forza orientamento landscape
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('landscape').catch(err => console.log('Orientamento non supportato:', err));
        }

        // Calcola distanza in metri (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = degToRad(lat2 - lat1);
            const dLon = degToRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(degToRad(lat1)) * Math.cos(degToRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function degToRad(deg) {
            return deg * (Math.PI / 180);
        }

        // Parsing NMEA per lat/lon (GPGGA) e velocità (GPRMC)
        function parseNMEA(nmea) {
            if (nmea.startsWith('$GPGGA')) {
                const parts = nmea.split(',');
                if (parts.length > 4) {
                    let lat = parseFloat(parts[2]) / 100;
                    let lon = parseFloat(parts[4]) / 100;
                    lat = Math.floor(lat) + (lat % 1) * 100 / 60;
                    lon = Math.floor(lon) + (lon % 1) * 100 / 60;
                    if (parts[3] === 'S') lat = -lat;
                    if (parts[5] === 'W') lon = -lon;

                    if (prevLat !== null && prevLon !== null) {
                        const distance = calculateDistance(prevLat, prevLon, lat, lon);
                        tripDistance += distance;
                        trip2Distance += distance;
                        updateDisplay();
                    }
                    prevLat = lat;
                    prevLon = lon;
                }
            } else if (nmea.startsWith('$GPRMC')) {
                const parts = nmea.split(',');
                if (parts.length > 7) {
                    const knots = parseFloat(parts[7]);
                    if (!isNaN(knots)) {
                        speed = knots * 1.852; // Converti knots in km/h
                        updateDisplay();
                    }
                }
            }
        }

        // Aggiorna display
        function updateDisplay() {
            document.getElementById('main-trip').textContent = `${Math.round(tripDistance)}`;
            document.getElementById('trip2').textContent = `${Math.round(trip2Distance)}`;
            document.getElementById('speed').textContent = `${Math.round(speed)} km/h`;
        }

        // Reset trip principale
        function resetTrip() {
            tripDistance = 0;
            prevLat = null;
            prevLon = null;
            updateDisplay();
        }

        // Reset trip2 su long press (3 secondi)
        const trip2Element = document.getElementById('trip2');
        trip2Element.addEventListener('touchstart', () => {
            pressTimer = setTimeout(() => {
                trip2Distance = 0;
                updateDisplay();
            }, 3000);
        });
        trip2Element.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
        });
        trip2Element.addEventListener('touchcancel', () => {
            clearTimeout(pressTimer);
        });

        // Connessione GPS Bluetooth via Web Serial (Garmin GLO)
        async function connectGPS() {
            try {
                const port = await navigator.serial.requestPort({ filters: [{ bluetoothServiceClassId: 'serial_port' }] });
                await port.open({ baudRate: 4800 });
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();

                (async () => {
                    let buffer = '';
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += value;
                        const lines = buffer.split('\r\n');
                        buffer = lines.pop();
                        lines.forEach(line => {
                            if (line.startsWith('$')) parseNMEA(line);
                        });
                    }
                })();
            } catch (err) {
                console.error('Errore GPS:', err);
            }
        }

        // GPS Interno
        function connectInternalGPS() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const spd = position.coords.speed; // m/s
                    speed = spd ? spd * 3.6 : 0; // Converti in km/h
                    if (prevLat !== null && prevLon !== null) {
                        const distance = calculateDistance(prevLat, prevLon, lat, lon);
                        tripDistance += distance;
                        trip2Distance += distance;
                        updateDisplay();
                    }
                    prevLat = lat;
                    prevLon = lon;
                }, err => {
                    console.error('Errore GPS interno:', err);
                }, { enableHighAccuracy: true });
            }
        }

        // Connessione Pulsante Remoto BLE
        async function connectButton() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['00001812-0000-1000-8000-00805f9b34fb'] }],
                    optionalServices: ['00001812-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('00001812-0000-1000-8000-00805f9b34fb');
                buttonCharacteristic = await service.getCharacteristic('00002a4d-0000-1000-8000-00805f9b34fb');
                await buttonCharacteristic.startNotifications();
                buttonCharacteristic.addEventListener('characteristicvaluechanged', event => {
                    const value = event.target.value.getUint8(0);
                    if (value === 1) {
                        resetTrip();
                    }
                });
            } catch (err) {
                console.error('Errore Pulsante:', err);
            }
        }
    </script>
</body>
</html>
