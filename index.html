<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rally TripMaster v4</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-main: #00FF00;
            --text-dim: #555555;
            --highlight: #FFFFFF;
            --alert: #FF0000;
            --last-val: #FF3333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 0;
            height: 100dvh; width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden;
            user-select: none; -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* LAYOUT ADATTIVO */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 20px;
            height: 30%;
            box-sizing: border-box;
            background-color: #080808;
        }

        /* TRIP B (Alto SX) */
        #tripB-container {
            display: flex; flex-direction: column;
            cursor: pointer; position: relative;
        }

        /* AREA VELOCITÀ E LAST RESET (Alto DX) */
        .right-stats {
            display: flex; flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        /* DIMENSIONI TESTI DINAMICI */
        .label {
            font-size: 3vh;
            color: var(--text-dim);
            font-weight: bold;
        }

        .value-small {
            font-size: 8vh; /* Più grande rispetto a prima */
            font-weight: bold;
            color: var(--text-main);
            line-height: 1;
        }

        /* Ultimo reset (Freeze) */
        #last-reset-display {
            font-size: 5vh;
            color: var(--last-val);
            font-weight: bold;
            margin-top: 1vh;
            min-height: 5vh;
        }

        /* AREA CENTRALE (Trip A) */
        .main-trip-container {
            flex-grow: 1;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border-top: 2px solid #222;
            position: relative;
            background-color: #000;
        }

        /* Media Queries per il Landscape (Orizzontale) */
        @media (orientation: landscape) {
            .main-trip-value {
                font-size: 45vh !important; /* Molto più grande in orizzontale */
            }
            .value-small {
                font-size: 12vh;
            }
            #last-reset-display {
                font-size: 7vh;
            }
        }

        .main-trip-value {
            font-size: 28vh;
            line-height: 0.8;
            font-weight: bold;
            color: var(--highlight);
            font-variant-numeric: tabular-nums;
            transition: font-size 0.2s;
        }

        .main-trip-unit {
            font-size: 4vh;
            color: var(--text-dim);
            letter-spacing: 10px;
        }

        /* PULSANTE INFO */
        .info-btn {
            position: absolute; bottom: 20px; right: 20px;
            width: 50px; height: 50px;
            background: #111; border: 1px solid #333; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #888; z-index: 50;
        }

        /* DEBUG PANEL */
        .debug-panel {
            display: none; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.98); z-index: 100;
            flex-direction: column; padding: 30px;
        }

        .reset-progress {
            position: absolute; bottom: -5px; left: 0;
            height: 6px; background-color: var(--alert); width: 0%;
        }

        .flash { animation: flash-anim 0.2s; }
        @keyframes flash-anim { 0% { background-color: #444; } 100% { background-color: #000; } }
    </style>
</head>
<body>

    <div class="top-bar">
        <div id="tripB-container">
            <span class="label">TRIP B</span>
            <span class="value-small" id="tripB-val">0.00</span>
            <div class="reset-progress" id="reset-bar"></div>
        </div>

        <div class="right-stats">
            <div>
                <span class="label">KM/H</span>
                <span class="value-small" id="speed-val">0</span>
            </div>
            <div id="last-reset-display"></div>
        </div>
    </div>

    <div class="main-trip-container" id="click-area" onclick="handleTapResetA()">
        <span class="main-trip-value" id="tripA-val">0</span>
        <span class="main-trip-unit">METRI</span>
    </div>

    <div class="info-btn" onclick="toggleDebug()">i</div>

    <div class="debug-panel" id="debug-panel">
        <h2 style="color:white;">DIAGNOSTICA v4.0</h2>
        <div id="dbg-content" style="font-family:monospace; font-size: 1.2rem; color: #ccc;">
            Hz: <span id="dbg-hz">--</span><br>
            Acc: <span id="dbg-acc">--</span> m<br>
            Spd: <span id="dbg-spd">--</span> m/s<br>
            Fix: <span id="dbg-status">--</span>
        </div>
        <button style="margin-top:20px; padding:20px;" onclick="goFullscreen()">FULLSCREEN</button>
        <button style="margin-top:10px; padding:20px;" onclick="toggleDebug()">CHIUDI</button>
    </div>

    <script>
        let tripA = 0.0;
        let tripB = 0.0;
        let lastLat = null, lastLon = null;
        let updateTimestamps = [];

        const elTripA = document.getElementById('tripA-val');
        const elTripB = document.getElementById('tripB-val');
        const elSpeed = document.getElementById('speed-val');
        const elLastReset = document.getElementById('last-reset-display');
        const elResetBar = document.getElementById('reset-bar');

        // FUNZIONE RESET TRIP A (Con salvataggio valore)
        function handleTapResetA() {
            // Salva il valore prima di azzerare
            let valToSave = Math.floor(tripA);
            elLastReset.innerText = "L: " + valToSave;
            
            tripA = 0;
            updateUI();
            flashElement(document.querySelector('.main-trip-container'), 'flash');
        }

        function updateUI() {
            elTripA.innerText = Math.floor(tripA);
            elTripB.innerText = (tripB / 1000).toFixed(2);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function handlePosition(pos) {
            const crd = pos.coords;
            const now = Date.now();
            
            // Debug Hz
            updateTimestamps.push(now);
            updateTimestamps = updateTimestamps.filter(t => t > now - 2000);
            document.getElementById('dbg-hz').innerText = (updateTimestamps.length / 2).toFixed(1);
            document.getElementById('dbg-acc').innerText = crd.accuracy.toFixed(1);

            // Velocità
            let speedKmh = (crd.speed || 0) * 3.6;
            elSpeed.innerText = speedKmh.toFixed(0);

            // Distanza
            if (lastLat !== null && lastLon !== null) {
                let dist = calculateDistance(lastLat, lastLon, crd.latitude, crd.longitude);
                
                // Filtro movimento (speed > 0.8 km/h o salto > 0.1m con buona precisione)
                if ((crd.speed > 0.22) || (crd.accuracy < 10 && dist > 0.1)) {
                    tripA += dist;
                    tripB += dist;
                    updateUI();
                }
            }
            lastLat = crd.latitude; lastLon = crd.longitude;
        }

        navigator.geolocation.watchPosition(handlePosition, (err) => console.log(err), {
            enableHighAccuracy: true, timeout: 5000, maximumAge: 0
        });

        // RESET TOTALE (Trip B) - Touch Prolungato
        let pressTimer;
        document.getElementById('tripB-container').addEventListener('touchstart', (e) => {
            elResetBar.style.width = "100%";
            elResetBar.style.transition = "width 3s linear";
            pressTimer = setTimeout(() => {
                tripA = 0; tripB = 0;
                elLastReset.innerText = ""; // Pulisce l'ultimo valore salvato
                updateUI();
                elResetBar.style.width = "0%";
            }, 3000);
        });
        document.getElementById('tripB-container').addEventListener('touchend', () => {
            clearTimeout(pressTimer);
            elResetBar.style.transition = "none";
            elResetBar.style.width = "0%";
        });

        // BLUETOOTH RESET
        let keyClicks = 0, keyTimer;
        window.addEventListener('keydown', (e) => {
            if (["Enter", " ", "VolumeUp", "VolumeDown", "AudioVolumeUp"].includes(e.key)) {
                keyClicks++;
                clearTimeout(keyTimer);
                keyTimer = setTimeout(() => {
                    if (keyClicks >= 3) {
                        tripA = 0; tripB = 0; elLastReset.innerText = "";
                    } else {
                        handleTapResetA();
                    }
                    updateUI(); keyClicks = 0;
                }, 400);
            }
        });

        function flashElement(el, cls) {
            el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls);
        }
        function toggleDebug() {
            const p = document.getElementById('debug-panel');
            p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
        }
        function goFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        // Keep Screen Awake
        if ('wakeLock' in navigator) { navigator.wakeLock.request('screen'); }
    </script>
</body>
</html>
